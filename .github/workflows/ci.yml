name: üîç CI/CD Pipeline - Qualidade de C√≥digo

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # 1Ô∏è‚É£ Valida√ß√£o de Depend√™ncias
  dependencies:
    name: üì¶ Depend√™ncias & Setup
    runs-on: ubuntu-latest
    
    steps:
      - name: ‚úÖ Checkout c√≥digo
        uses: actions/checkout@v4
        
      - name: üì• Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
          
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.17'
          
      - name: üîó Instalar depend√™ncias
        run: pnpm install
        
      - name: üîê Validar vari√°veis de ambiente
        run: pnpm run validate-env
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}

  # 2Ô∏è‚É£ Linting & Formata√ß√£o
  lint:
    name: üé® Lint & Formata√ß√£o
    runs-on: ubuntu-latest
    needs: dependencies
    
    steps:
      - name: ‚úÖ Checkout c√≥digo
        uses: actions/checkout@v4
        
      - name: üì• Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
          
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.17'
          
      - name: üîó Instalar depend√™ncias
        run: pnpm install
        
      - name: üé® Rodar ESLint
        run: pnpm lint
        continue-on-error: false
        
      - name: üìù Comment no PR (se houver erros)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **ESLint falhou!** Favor corrigir os erros de linting antes de fazer merge.'
            })

  # 3Ô∏è‚É£ Type Checking
  type-check:
    name: üîç Type Checking
    runs-on: ubuntu-latest
    needs: dependencies
    
    steps:
      - name: ‚úÖ Checkout c√≥digo
        uses: actions/checkout@v4
        
      - name: üì• Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
          
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.17'
          
      - name: üîó Instalar depend√™ncias
        run: pnpm install
        
      - name: üîç Verificar tipos TypeScript
        run: pnpm type-check
        
      - name: üìù Comment no PR (se houver erros)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **Type checking falhou!** Favor corrigir os erros de tipo TypeScript.'
            })

  # 4Ô∏è‚É£ Build Validation
  build:
    name: üèóÔ∏è Build & Valida√ß√£o
    runs-on: ubuntu-latest
    needs: [lint, type-check]
    
    steps:
      - name: ‚úÖ Checkout c√≥digo
        uses: actions/checkout@v4
        
      - name: üì• Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
          
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.17'
          
      - name: üîó Instalar depend√™ncias
        run: pnpm install
        
      - name: üèóÔ∏è Build do projeto
        run: pnpm build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          
      - name: üìù Comment no PR (se houver erros)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **Build falhou!** Favor revisar os erros e tentar novamente.'
            })

  # 5Ô∏è‚É£ Security Check
  security:
    name: üîí Verifica√ß√£o de Seguran√ßa
    runs-on: ubuntu-latest
    needs: dependencies
    
    steps:
      - name: ‚úÖ Checkout c√≥digo
        uses: actions/checkout@v4
        
      - name: üì• Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
          
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.17'
          
      - name: üîó Instalar depend√™ncias
        run: pnpm install
        
      - name: üîí Verificar vulnerabilidades npm
        run: npm audit --audit-level=moderate
        continue-on-error: true
        
      - name: üîê Verificar secrets expostos
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

  # 6Ô∏è‚É£ Code Quality Summary
  quality-summary:
    name: ‚úÖ Resumo de Qualidade
    runs-on: ubuntu-latest
    needs: [dependencies, lint, type-check, build, security]
    if: always()
    
    steps:
      - name: ‚úÖ Checkout c√≥digo
        uses: actions/checkout@v4
        
      - name: üéØ Status de todos os jobs
        run: |
          echo "## üìä Resumo da Esteira CI/CD" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Verifica√ß√£o | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| üì¶ Depend√™ncias | ${{ needs.dependencies.result == 'success' && '‚úÖ Passou' || '‚ùå Falhou' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üé® Lint & Formata√ß√£o | ${{ needs.lint.result == 'success' && '‚úÖ Passou' || '‚ùå Falhou' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üîç Type Checking | ${{ needs.type-check.result == 'success' && '‚úÖ Passou' || '‚ùå Falhou' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üèóÔ∏è Build | ${{ needs.build.result == 'success' && '‚úÖ Passou' || '‚ùå Falhou' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üîí Seguran√ßa | ${{ needs.security.result == 'success' && '‚úÖ Passou' || '‚ö†Ô∏è Verificado' }} |" >> $GITHUB_STEP_SUMMARY
          
      - name: ‚ùå Falhar se algum job falhou
        if: |
          needs.dependencies.result == 'failure' ||
          needs.lint.result == 'failure' ||
          needs.type-check.result == 'failure' ||
          needs.build.result == 'failure'
        run: exit 1
        
      - name: ‚úÖ Comentar sucesso no PR
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ **Todos os requisitos de qualidade foram atendidos!** Pronto para merge.'
            })
